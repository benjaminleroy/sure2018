---
title: "Merging Datasets"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)

sure_path <- substr(getwd(), 1, nchar(getwd()) - 4)
individual_path <- paste(sure_path, "/data/individual_database.csv", sep = "")
individual <- read_csv(individual_path, 
                       col_types = cols(X1 = col_skip(), 
                                        meansOfControlRestrictsFinancialAccess = col_integer(), 
                                        meansOfControlSexualAbuse = col_integer(), 
                                        meansOfControlUsesChildren = col_integer(), 
                                        typeOfSexPornography = col_integer(), 
                                        typeOfSexRemoteInteractiveServices = col_integer(), 
                                        typeOfSexPrivateSexualServices = col_integer()))

#converts year of registration and ageBroad into ordered factors
individual$yearOfRegistration <- as.ordered(individual$yearOfRegistration)
individual$ageBroad <- as.ordered(individual$ageBroad)
individual$ageBroad <- fct_relevel(individual$ageBroad, "0--8", "9--17", 
                                   "18--20", "21--23", "24--26", "27--29", 
                                   "30--38", "39--47", "48+")

#converts the columns with characters into unordered factors
factor_cols <- c("Datasource", "gender", "majorityStatus", "majorityEntry", 
                 "citizenship", "RecruiterRelationship", "CountryOfExploitation")

for (column in factor_cols) {
  individual[,column] <- as.factor(unlist(individual[,column]))
}


country_path <- paste(sure_path, "/data/country_summary_dat.csv", sep = "")
country <- read_csv(country_path, 
                    col_types = cols(X1 = col_skip(),
                                     poverty2015 = col_double(), 
                                     poverty2016 = col_double(), 
                                     poverty2017 = col_double(), 
                                     poverty2018 = col_double(), 
                                     gender2006 = col_double(), 
                                     gender2007 = col_double(), 
                                     gender2008 = col_double(), 
                                     gender2009 = col_double(), 
                                     gender2010 = col_double(), 
                                     gender2011 = col_double(), 
                                     gender2012 = col_double(), 
                                     gender2013 = col_double(), 
                                     gender2014 = col_double(), 
                                     gender2015 = col_double(), 
                                     gender2016 = col_double(), 
                                     gender2017 = col_double(), 
                                     gdp_per_capita2017 = col_double()),
                    na = c("", "NA", "N/A")
  
)


population_path <- paste(sure_path, "/data/population.csv", sep = "")
population <- read_csv(population_path, 
                       col_types = cols(X1 = col_skip()))

#readr has trouble reading the numbers in their original format
population[,-(1:2)] <- sapply(population[,-(1:2)], str_replace_all, " ", "")
population[,-(1:2)] <- sapply(population[,-(1:2)], str_replace, "[.]", "")
population[,-(1:2)] <- sapply(population[,-(1:2)], as.numeric)


migration_path <- paste(sure_path, "/data/migration.csv", sep = "")
migration <- read_csv(migration_path, col_types = cols(X1 = col_skip()))

migration$value <- str_replace_all(migration$value, "[..]", "0")
migration$value <- str_replace_all(migration$value, ",", "")
#will throw an "NAs introduced by coercion" error but I think those rows have 
#NAs in the original dataset and the error is safe to ignore
migration$value <- as.numeric(migration$value) 
```

## Shiva

```{r}

```

## Imani 

```{r}
library(tidyverse)

#filling missing values in the country summary data set
sure_path <- substr(getwd(), 1, nchar(getwd()) - 4)
source(paste(sure_path, "/functions/linearly_interpolate.R", sep = ""))
country <- linearly_interpolate(country, list(6:15, 32:60, 61:72, 73:130, 
                                              138:131, 149:139))

#Clearing NA's from cCountry.y by copying a lowercase version of Country.X
country <-country %>% filter(!(is.na(Country.y) & is.na(Country.x)))


country$Country.y= tolower(country$Country.x)

country$Country.y <-str_to_title(country$Country.y)

#melting poverty data

library(reshape2)
poverty_data<-select(country, Country.y:Country.x, `Country Code`, poverty2002:poverty2017)


names(poverty_data)[4:19]=as.character(2002:2017)

poverty_data<-poverty_data%>%melt(id=c("Country.y","Country.x","Country Code"), 
                                  variable.name = "Year",
                                          value.name = "Poverty")


poverty_data <- poverty_data %>% arrange(Country.y, Country.x)





#melting gdp data


gdp_data<-select(country, Country.y:Country.x, `Country Code`,
                 gdp_per_capita2002:gdp_per_capita2017)


names(gdp_data)[4:19]=as.character(2002:2017)

gdp_data<-gdp_data%>%melt(id=c("Country.y","Country.x","Country Code"), 
                                  variable.name = "Year",
                                  value.name = "GDP")



gdp_data <- gdp_data %>% arrange(Country.y, Country.x)



#melting bribes data
bribe_data<-select(country, Country.y:Country.x, `Country Code`,
                   bribes2017:bribes2010)


names(bribe_data)[4:11]=as.character(2010:2017)

bribe_data<-bribe_data%>%melt(id=c("Country.y","Country.x","Country Code"), 
                              variable.name = "Year",
                              value.name = "Bribe")


bribe_data <- bribe_data %>% arrange(Country.y, Country.x)





#melting crime 

crime_data<-select(country, Country.y:Country.x, `Country Code`,
                   organized_crime2017:organized_crime2007)


names(crime_data)[4:14]=as.character(2007:2017)

crime_data<-crime_data%>%melt(id=c("Country.y","Country.x","Country Code"), 
                              variable.name = "Year",
                              value.name = "Crime")


crime_data <- crime_data %>% arrange(Country.y, Country.x)










#melting gender data
gender_data<-select(country, Country.x:Country.y, `Country Code`,
                    gender2006:gender2017)


names(gender_data)[4:15]=as.character(2006:2017)

gender_data<-gender_data%>%melt(id=c("Country.y","Country.x","Country Code"), 
                                variable.name = "Year",
                                value.name = "Gender")


gender_data <- gender_data %>% arrange(Country.y, Country.x)






#melting tier data
tier_data<-select(country, Country.y:Country.x, `Country Code`,
                  tier2002:tier2017)


names(tier_data)[4:19]=as.character(2002:2017)

tier_data<-tier_data%>%melt(id=c("Country.y","Country.x","Country Code"), 
                            variable.name = "Year",
                            value.name = "Tier")


tier_data <- tier_data %>% arrange(Country.y, Country.x)





#melting peace data
peace_data<-select(country, Country.y:Country.x, `Country Code`,
                   peace2008:peace2017)


names(peace_data)[4:13]=as.character(2008:2017)




peace_data<-peace_data%>%melt(id=c("Country.y","Country.x","Country Code"), 
                              variable.name = "Year",
                              value.name = "Peace")


peace_data <- peace_data %>% arrange(Country.y, Country.x)






#merging data sets together
library(plyr)
cdataframes<- list(poverty_data, gdp_data, bribe_data, crime_data, gender_data,
                   peace_data,tier_data)



country_merge<-join_all(cdataframes,  by=(c("Country.y"="Country.y",
                             "Country.x"="Country.x", "Country Code",
                             "Year"="Year")), type='left')



```

```{r}

poverty_data

```


```{r}

inactiveFunct = function(x) {
#merging data sets together (THIS WIL BREAK YOUR COMPUTER DO NOT RUN)
library(plyr)
cdataframes<- list(poverty_data, gdp_data, bribe_data, crime_data, gender_data)



country_merge<-join_all(cdataframes,  by=(c("Country.y"="Country.y",
                             "Country.x"="Country.x",
                             "Year"="Year")), type='left')

country_merge<- country_merge%>% left_join(tier_data,
                                           by=(c("Country.y"="Country.y",
                                              "Country.x"="Country.x",
                                              "Year"="Year")))%>%
                                    
                                  left_join(peace_data,
                                            by=(c("Country.y"="Country.y",
                                                  "Country.x"="Country.x",
                                                  "Year"="Year")))
}
```

#Michael
```{r}

#For me to do: Put your migrationFromAllCountryToWorld in Shiva's linear interpolation function.
#In the functions folder.
#Need to transform the data into columns with 1990, 1991, etc... and rows country A, country B, etc...

library(tidyverse)
library(reshape2)



#Gives total migration from all countries to WORLD in 1990, 1995, 2000, 2005, 2010, 2015, 2017.
migrationFromAllCountryToWorldBools <- migration$`Major area, region, country or area of destination` == "WORLD"
migrationFromAllCountryToWorld <- migration[migrationFromCountryToWorldBools, ]
migrationFromAllCountryToWorld <- na.omit(migrationFromCountryToWorld)
View(migrationFromAllCountryToWorld)


#Gives total migration from WORLD to all countries in 1990, 1995, 2000, 2005, 2010, 2010, 2015, 2017
year_vec <- c(1990, 1995, 2000, 2005, 2010, 2015, 2017)
migration_counts = data.frame()
for(i in year_vec) {
  df = migration %>% filter(Year == i)
  df_phony = data.frame()
  df_mig <- tapply(df$value, df$`Major area, region, country or area of destination`, sum)
  year <- rep(i, length(df_mig))
  df_phony <- cbind(year, df_mig)
  migration_counts = rbind(migration_counts, df_phony)
}
View(migration_counts)

########################

#Potentially useful package for converting full name to country code, vice versa
install.packages("countrycode")
library(countrycode)
?codelist
listOfCountryLongNames <- migration$variable[!duplicated(migration$variable)]
countryName_vec <- as.vector(listOfCountryLongNames)

#######################

#Convert Country.Y, Country.X, and 3 Letter Code of COUNTRY dataset to 2 Letter Code
countryY_vec <- country %>% pull(Country.y) %>% as.vector()
countryX_vec <- country %>% pull(Country.x) %>% as.vector()
country3LCode_vec <- country %>% pull(`Country Code`) %>% as.vector()
countryXY3L_vec <- data.frame(countryY_vec, countryX_vec, country3LCode_vec)
country2LCode_vec <- countrycode(countryXY3L_vec$country3LCode_vec, 'genc3c', 'genc2c')
countryXY3L2LCode_vec <- countryXY3L_vec %>% mutate(country2LCode_vec)
View(countryXY3L2LCode_vec)
#What do I do with missing countries? I can get rid of them with na.omit

#######################

#Convert 2 Letter Country Code of individual$citizenship to Full Country Name and 3 Letter Codes
indvl_2LCCodesCitizen <- individual %>% pull(citizenship) %>% as.vector()
indvl_3LCCodesCitizen <- countrycode(indvl_2LCCodesCitizen, 'genc2c', 'genc3c') %>% as.vector()
indvl_fullCNameCitizen <- countrycode(indvl_2LCCodesCitizen, 'genc2c', 'country.name') %>% as.vector()
multiName_individual <- individual %>% mutate(indvl_3LCCodesCitizen, indvl_fullCNameCitizen) %>% select (citizenship, indvl_3LCCodesCitizen, indvl_fullCNameCitizen, everything())
indvl_2LCCodesTraffick <- individual %>% pull(CountryOfExploitation) %>% as.vector()
indvl_3LCCodesTraffick <- countrycode(indvl_2LCCodesTraffick, 'genc2c', 'genc3c') %>% as.vector()
indvl_fullCNameTraffick <- countrycode(indvl_2LCCodesTraffick, 'genc2c', 'country.name') %>% as.vector()

#Adds full name and 3 letter codes to individual database
manyNames_individual <- multiName_individual %>% mutate(indvl_3LCCodesTraffick, indvl_fullCNameTraffick) %>% select(CountryOfExploitation, indvl_3LCCodesTraffick, indvl_fullCNameTraffick, everything())
View(manyNames_individual)

#migCountryOfCitizenTOTraffickCountry finds migration from citizenship country to trafficked country
#In 1990, 1995, 2000, 2005, 2010, 2010, 2015, 2017
###STILL WORKING ON THIS

#ctrl shift c to comment out / in 
# for(i in 1:nrow(manyNames_individual)) {
# 
#   df = migration %>% filter(indvl_fullCNameCitizen)
#   df_temp = data.frame()
#   df_migration <-
# 
# 
# )
# 
# migCountryOfCitizenToTraffickCountry <-
# 
# 
# 
# 
# manyNameIndiv_vec <- manyNames_individual %>% as.vector()
# for(i in manyNameIndiv_vec) {
#   
#   
#   
# }
# migrationFromWorldToCountryBools <- migration_counts$df_mig == ""
# #Need merged dataset to fill in "" above: mergedDataSet$traffickedCountry
# migWorldToCountrySubset <- migration_counts[migrationFromWorldToCountryBools,]
# View(migWorldToCountrySubset)

  

#migCountryOfCitizenToWorld finds migration from citizenship country to world
#Need to filter by year of migration?


migByCitizCountryToWorld <- data.frame()
migByCitizCountryToWorld_df <- data.frame()
migByCitizCountryToWorldByYear <- data.frame()
migByCitizCountryToWorldByYear_df <- data.frame()
yearOfTrafficking_vec <- manyNames_individual %>% pull(yearOfRegistration) %>% as.vector()
indvl_fullCNameCitizen_vec <- indvl_fullCNameCitizen[!duplicated(indvl_fullCNameCitizen)] %>% as.vector()
for(i in indvl_fullCNameCitizen_vec) {
  migByCitizCountryToWorld_df = migrationFromAllCountryToWorld %>% filter(variable == i)
  migByCitizCountryToWorld = rbind(migByCitizCountryToWorld, migByCitizCountryToWorld_df)
}
#Must wait for Shiva's stratifaction to get estimates for every year.
for(j in yearOfTrafficking_vec) {
  migByCitizCountryToWorldByYear_df = migByCitizCountryToWorld %>% filter(Year == j)
  migByCitizCountryToWorldByYear = rbind(migByCitizCountryToWorldByYear, migByCitizCountryToWorldByYear_df)
}
View(migByCitizCountryToWorldByYear)


  



```

