---
title: "Merging Datasets"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)

sure_path <- substr(getwd(), 1, nchar(getwd()) - 4)
individual_path <- paste(sure_path, "/data/individual_database.csv", sep = "")
individual <- read_csv(individual_path, 
                       col_types = cols(X1 = col_skip(), 
                                        meansOfControlRestrictsFinancialAccess = col_integer(), 
                                        meansOfControlSexualAbuse = col_integer(), 
                                        meansOfControlUsesChildren = col_integer(), 
                                        typeOfSexPornography = col_integer(), 
                                        typeOfSexRemoteInteractiveServices = col_integer(), 
                                        typeOfSexPrivateSexualServices = col_integer()))

#converts year of registration and ageBroad into ordered factors
individual$yearOfRegistration <- as.ordered(individual$yearOfRegistration)
individual$ageBroad <- as.ordered(individual$ageBroad)
individual$ageBroad <- fct_relevel(individual$ageBroad, "0--8", "9--17", 
                                   "18--20", "21--23", "24--26", "27--29", 
                                   "30--38", "39--47", "48+")

#converts the columns with characters into unordered factors
factor_cols <- c("Datasource", "gender", "majorityStatus", "majorityEntry", 
                 "citizenship", "RecruiterRelationship", "CountryOfExploitation")

for (column in factor_cols) {
  individual[,column] <- as.factor(unlist(individual[,column]))
}


country_path <- paste(sure_path, "/data/country_summary_dat.csv", sep = "")
country <- read_csv(country_path, 
                    col_types = cols(X1 = col_skip(),
                                     poverty2015 = col_double(), 
                                     poverty2016 = col_double(), 
                                     poverty2017 = col_double(), 
                                     poverty2018 = col_double(), 
                                     gender2006 = col_double(), 
                                     gender2007 = col_double(), 
                                     gender2008 = col_double(), 
                                     gender2009 = col_double(), 
                                     gender2010 = col_double(), 
                                     gender2011 = col_double(), 
                                     gender2012 = col_double(), 
                                     gender2013 = col_double(), 
                                     gender2014 = col_double(), 
                                     gender2015 = col_double(), 
                                     gender2016 = col_double(), 
                                     gender2017 = col_double(), 
                                     gdp_per_capita2017 = col_double()),
                    na = c("", "NA", "N/A")
  
)


population_path <- paste(sure_path, "/data/population.csv", sep = "")
population <- read_csv(population_path, 
                       col_types = cols(X1 = col_skip()))

#readr has trouble reading the numbers in their original format
population[,-(1:2)] <- sapply(population[,-(1:2)], str_replace_all, " ", "")
population[,-(1:2)] <- sapply(population[,-(1:2)], str_replace, "[.]", "")
population[,-(1:2)] <- sapply(population[,-(1:2)], as.numeric)


migration_path <- paste(sure_path, "/data/migration.csv", sep = "")
migration <- read_csv(migration_path, col_types = cols(X1 = col_skip()))

migration$value <- str_replace_all(migration$value, "[..]", "0")
migration$value <- str_replace_all(migration$value, ",", "")
#will throw an "NAs introduced by coercion" error but I think those rows have 
#NAs in the original dataset and the error is safe to ignore
migration$value <- as.numeric(migration$value) 
```

## Shiva

```{r}

```

## Imani and Michael

```{r}
library(reshape2)
#dataset of poverty
#melting poverty data

library(tidyverse)
library(reshape2)
poverty_data<-select(country, Country.y:Country.x, poverty2002:poverty2017)


names(poverty_data)[3:18]=as.character(2002:2017)

poverty_data<-poverty_data%>%melt(id=c("Country.x","Country.y"), 
                                  variable.name = "Year",
                                          value.name = "Poverty")


poverty_data <- poverty_data %>% arrange(Country.x, Country.y)









#melting gdp data


gdp_data<-select(country, Country.y:Country.x,
                 gdp_per_capita2002:gdp_per_capita2017)


names(gdp_data)[3:18]=as.character(2002:2017)

gdp_data<-gdp_data%>%melt(id=c("Country.x","Country.y"), 
                                  variable.name = "Year",
                                  value.name = "GDP")



gdp_data <- gdp_data %>% arrange(Country.x, Country.y)




#melting bribes data
bribe_data<-select(country, Country.y:Country.x, bribes2017:bribes2010)


names(bribe_data)[3:10]=as.character(2010:2017)

bribe_data<-bribe_data%>%melt(id=c("Country.x","Country.y"), 
                              variable.name = "Year",
                              value.name = "Bribe")


bribe_data <- bribe_data %>% arrange(Country.x, Country.y)





#melting crime 

crime_data<-select(country, Country.y:Country.x, 
                   organized_crime2017:organized_crime2007)


names(crime_data)[3:13]=as.character(2007:2017)

crime_data<-crime_data%>%melt(id=c("Country.x","Country.y"), 
                              variable.name = "Year",
                              value.name = "Crime")


crime_data <- crime_data %>% arrange(Country.x, Country.y)









#melting gender data
gender_data<-select(country, Country.x:Country.y, gender2006:gender2017)


names(gender_data)[3:14]=as.character(2006:2017)

gender_data<-gender_data%>%melt(id=c("Country.y","Country.x"), 
                                variable.name = "Year",
                                value.name = "Gender")


gender_data <- gender_data %>% arrange(Country.x, Country.y)





#melting tier data
tier_data<-select(country, Country.y:Country.x, tier2002:tier2017)


names(tier_data)[3:18]=as.character(2002:2017)

tier_data<-tier_data%>%melt(id=c("Country.x","Country.y"), 
                            variable.name = "Year",
                            value.name = "Tier")


tier_data <- tier_data %>% arrange(Country.x, Country.y)




#melting peace data
peace_data<-select(country, Country.y:Country.x, peace2008:peace2017)


names(peace_data)[3:12]=as.character(2008:2017)


peace_data<-peace_data%>%melt(id=c("Country.x","Country.y"), 
                              variable.name = "Year",
                              value.name = "Peace")


peace_data <- peace_data %>% arrange(Country.x, Country.y)



inactiveFunct = function(x) {
#merging data sets together (THIS WIL BREAK YOUR COMPUTER DO NOT RUN)
library(plyr)
cdataframes<- list(poverty_data, gdp_data, bribe_data, crime_data, gender_data)



country_merge<-join_all(cdataframes,  by=(c("Country.y"="Country.y",
                             "Country.x"="Country.x",
                             "Year"="Year")), type='left')

country_merge<- country_merge%>% left_join(tier_data,
                                           by=(c("Country.y"="Country.y",
                                              "Country.x"="Country.x",
                                              "Year"="Year")))%>%
                                    
                                  left_join(peace_data,
                                            by=(c("Country.y"="Country.y",
                                                  "Country.x"="Country.x",
                                                  "Year"="Year")))
}
```
